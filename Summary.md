# Основы реляционной модели

## Отношение (таблица)

 Реляционная модель определяет способ представления данных (структуру данных), методы защиты данных (целостность данных), и операции, которые можно выполнять с данными (манипулирование данными).

<img title="" src="file:///C:/Users/molos/AppData/Roaming/marktext/images/2023-03-30-13-07-17-image.png" alt="" width="570" data-align="center">

*Отношение* - структура данных целиком, набор записей (иногда называют таблица)

*Кортеж* - каждая строка, содержащая данные (иногда называют запись)

*Мощность* - число кортежей в таблице

*Атрибут* - столбец в таблице (иногда называют поле)

*Размерность* - число атрибутов в таблице

*Домен атрибута* - допустимые значения, которые можно занести в поле

### Отношение, реляционная модель

Обязательным этапом перед созданием БД является ее проектирование.

Имя таблицы (отношения) должно быть уникальным в пределах БД. Рекомендуется существительное в единственном числе, понятное имя, описывающее моделируемый объект, имя должно быть короткое (до 10 символов).

Имя поля должно быть уникальным в пределах таблицы. Рекомендуется разделять составные имена подчеркиванием.

Ключевые поля должны состоять из двух частей: названия таблицы и `id`, например `book_id`.

### Типы данных полей

`int, integer` - целые числа (32 bit)

`decimal, numeric` - вещественное число, в скобках указывается максимальная длина числа. Например `decimal(6,3)` означает вещественное число с 6 цифрами в числе и 3 цифры после запятой, например для `decimal(6,3)` это `123,456`. 

`date` - дата в формате ГГГГ-ММ-ДД

`varchar` - строка длиной не более 255 символов в однобайтовой кодировке.

Для описания ключевого поля можно использовать `int primary key auto_increment`

### Создание таблицы

Для создания таблицы используется SQL-запрос. Ключевое слово `create table`. Пример запроса:

```sql
create table genre(
    genre_id int primary key auto_increment,
    name_genre varchar(30)
);
```

В конце sql-запроса ставится точка с запятой. Но для одного запроса это не обязательно.

### Вставка записи в таблицу

Для занесения новой записи в таблицу используется SQL-запрос, в котором указывается в какую таблицу, в какие поля заносить новые значения.

Пример запроса:

```sql
insert into table(field1, field2)
values (value1, value2);
```

В результате выполнения этого запроса новая запись добавится в конец указанной таблицы.

Рекомендуется заполнять все поля записи, если же поле пропущено, значение этого поля зависит от установленных по умолчанию значений, если значения не установлены, то вставляется `null`.

Значения поля `primary key auto_increment` формируется автоматически, т.е. его не нужно указывать при добавлении значения в таблицу.

---

## Выборка данных

### Выборка всех данных из таблицы

Для выборки данных из таблицы используется ключевое слово `select`. Также для выборки всех данных без указания атрибутов таблицы можно использовать знак `*`. Таким образом для выборки всех записей из таблицы используется запрос:

```sql
select * from table
```

### Выборка отдельных столбцов

Для выборки отдельных столбцов после ключевого слова `select` необходимо написать атрибуты, которые мы хотим видеть в выборке. Например:

```sql
select attribute1,
       attrubite2
from table;
```

### Выборка новых столбцов и присвоение им новых имен

Для того чтобы присвоить атрибуту новое имя используется ключевое слово `as`. Например:

```sql
select attribute1 as new_name_attribute1,
       attribute2
from table;
```

### Выборка данных с созданием вычисляемого столбца

Результатом выборки является таблица, в которую включены все данные из указанных после `select` столбцов, а также новый столбец, в каждой строке которого вычисляется заданное выражение.

Например:

```sql
select attribute1,
       attribute2,
       attribute3 * constant as new_attribute3
from table;
```

### Выборка данных, вычисляемые столбцы, математические функции

Некоторые из функций, реализованных в SQL:

1. `ceiling(x)` - округление до целого в большую сторону

2. `round(x,k)` - округление **x** до **k** знаков после запятой, если не указано **k**, то округлят до целого

3. `floor(x)` - округляет до целого числа в меньшую сторону

4. `power(x,y)` - возведение **x** в степень **y**

5. `sqrt(x)` - квадратный корень из **x**

6. `degrees(x)` - конвертирует значение **x** из радиан в градусы

7. `radians(x)` - конвертирует значение **и** из градусов в радианы

8. `abs(x)` - модуль числа **x**

9. `PI()` - число $\pi$

### Выборка данных, вычисляемые столбцы, логические функции

В SQL можно заносить в поле значение на основании условия. Для это применяют функцию `if()`:

```sql
if(expression, result_if_true, result_if_false)
```

### Выборка данных по условию

С помощью запросов можно включать в итоговую выборку не все строки исходной таблицы, а только те, которые соответствуют условию. Для этого после указания таблицы задается ключевое слово `where` и логическое выражение.

Операторы сравнения могут быть:

| Оператор | Значение         |
|:--------:|:----------------:|
| =        | равно            |
| <>       | не равно         |
| >        | больше           |
| <        | меньше           |
| >=       | больше или равно |
| <=       | меньше или равно |

Например:

```sql
select attribute1,
       attribute2,
from table
where attribute1 * constant1 >= contstant2;
```

### Выборка данных, логические операции

Логическое выражение может включать логические операции `and` ,`or` ,`not` и круглые скобки.

Приоритет операций:

1. Скобки

2. Умножение, деление

3. Сложение, вычитание

4. Операторы сравнения

5. `not`

6. `and`

7. `or`

Например:

```sql
select attribute1,
       attribute2,
from table
where attribute1 > constant1 and attribute2 = contstant2;
```

### Выборка данных, операторы between, in

Логические выражения могут включать операторы `between` и `in`. Приоритет этих операторов как у оператора `if`.

Оператор `between` отбирает данные, относящиеся к некоторому интервалу, включая границы.

Оператор `in` выбирает данные, соответствующие значениям из списка.

### Выборка данных с сортировкой

Для сортировки используется ключевое слово `order by`, после которого указываются имена столбцов. Строки сортируются по первому столбцу, а если указан второй, то сортировка происходит только для тех строк, у которых значение первого столбца одинаковы. По умолчанию сортировка при помощи `order by` происходит по возрастанию, чтобы указать порядок сортировки после имени столбца можно указать ключевое слово `asc` (по возрастанию) или `desc` (по убыванию).

Столбцы для `order by`  можно указывать названием столбца, номером столбца или псевдонимом (указанным после `as`).

### Выборка данных, оператор like

Оператор `like` используется для сравнения строк. Этот оператор позволяет сравнивать строки на неполное совпадение, а по шаблону. Шаблон может включать любой символ и *символ-шаблон* (`%` и `_`). Где `%` - строка любой длины, а `_` - любой одиночный символ.

Например `like '%M.%'` выберет все строки, содержащие `M.`, а `like 'Поэм_'` выберет все строки, начинающиеся с `Поэм` и заканчивающиеся любым символом.

---

## Запросы, групповые операции

### Выбор уникальных элементов столбца

Чтобы отобрать уникальные элементы используют ключевое слово `distinct` после `select`.

Например:

```sql
select distinct attribute1
from table;
```

Для этого также можно использовать оператор `group by`, который группирует данные при выборке с одинаковыми значениями.

Тот же пример, что и выше, но с использованием `group by`

```sql
select attribute1
from table
group by author;
```

В разделе `group by` также можно указывать несколько столбцов, разделяя их запятыми. Тогда к одной группе будут относиться записи, у которых значения столбцов, входящих в группу, равны.

Пример:

```sql
select name, number_plate, violation, count(*)
from fine
group by name, number_plate, violation;
```

### Выборка данных, групповые функции SUM и COUNT

При группировке можно выполнить действие с элементами, входящими в группу, например просуммировать все сгруппированные значения.

Пример группировки:

```sql
select attribute1, 
       sum(attribute2), 
       sum(attribute3)
from table
group by attribute1;
```

`sum` позволяет сложить элементы каждой группы, а `count` позволяет посчитать количество элементов в каждой группе.

`count(*)` - подсчитывает все записи в группе, в том числе со значением `null`.

`count(attribute)` - подсчитывает все записи в группе с условием `not null`.

В агрегатных функциях (таких как `sum` и `count`) можно использовать ключевое слово `distinct` для подсчета уникальных значений.

### Выборка данных, групповые функции MIN, MAX, AVG

К групповым функциям относят: `min()`, `max()`, `avg()`.

### Выборка данных с вычислением, групповые функции

В качестве аргумента групповой функции может использоваться любое допустимое в SQL арифметическое выражение.

Например:

```sql
select attribute1,
       sum(attribute2 * attribute3) as name
from table
group by attribute1;
```

Групповые функции могут быть элементами выражений. Т.е. можно написать 

```sql
round(sum(attribute2 * attribute3), 2)
```

### Вычисления по таблице целиком

Групповые функции можно применять к целому столбцу без группировки.

Например:

```sql
select sum(attribute)
from table;
```

Результатом таких запросов является единственная строка с вычисленными по таблице значениями.

### Выборка данных по условию, групповые функции

В запросы с групповыми функциями можно включать условие отбора строк. В таких запросах вместо `where` используется ключевое слово `having`, которое размещается после `group by`.

Например:

```sql
select attribute1,
       min(attribute2),
       max(attribute2)
from table
group by attribute1
having sum(attribute2 * attribute3) > constant1
```

Оптимизация от ChatGPT:

```sql
WITH temp AS (
  SELECT attribute1, attribute2, attribute3
  FROM table
  WHERE (attribute2 IS NOT NULL) AND (attribute3 IS NOT NULL)
)
SELECT attribute1, MIN(attribute2), MAX(attribute2)
FROM temp
GROUP BY attribute1
HAVING SUM(attribute2 * attribute3) > constant1;
```

### Выборка данных по условию, групповые функции, WHERE и HAVING

`where` и `having` могут использоваться в одном запросе. При этом необходимо учитывать порядок выполнения SQL-запроса:

1. FROM

2. WHERE

3. GROUP BY

4. HAVING

5. SELECT

6. ORDER BY

Например:

```sql
select author,
    min(price) as Minimum_price,
    max(price) as Maximum_price
from book
where author <> 'Есенин С.А.'
group by author
having sum(amount) > 10;
```

---

## Вложенные запросы

Вложенный запрос - запрос внутри другого запроса SQL.

Вложенный запрос используется для выборки данных, которые будут использоваться в условии отбора записей основного запроса. Его применяют для:

- сравнения выражения с результатом вложенного запроса

- определения того, включено ли выражение в результаты вложенного запроса

- проверки того, выбирает ли запрос определенные строки

Составляющие вложенного запроса:

- Ключевое слово `select` после которого указываются имена столбцов или выражения
- Ключевое слово `from` и имя таблицы
- Необязательное предложение `where`
- Необязательное предложение `group by` и `having`

Вложенные запросы могут включаться в `where` и `having` так:

- `where | having` expression *оператор сравнения* (вложенный запрос)
- `where | having` expression, включающее вложенный запрос
- `where | having` expression `[NOT] IN` (вложенный запрос)
- `where | having` expression *оператор сравнения* `ANY | ALL` (вложенный запрос)

Также вложенные запросы могут вставляться в основной запрос после ключевого слова `select`.

### Вложенный запрос, возвращающий одно значение

Такой запрос может использоваться в условии отбора записей `where` как обычное значение вместе с операторами сравнения.

Например:

```sql
select title, author, price, amount
from book
where price = (
         select min(price) 
         from book
      );
```

Этот запрос выводит информацию о самых дешевых книгах, хранящихся на складе.

### Использование вложенного запроса в выражении

Вложенный запрос, возвращающий одно значение, можно использовать в выражениях как обычный операнд.

Например:

```sql
select title, author, amount 
from book
where abs(amount - (select avg(amount) from book)) >3;
```

Этот запрос выведет информацию о книгах, количество экземпляров которых отличается от среднего количества экземпляров книг на складе более чем на 3.

### Вложенный запрос, оператор IN

Вложенный запрос может возвращать несколько значений одного столбца. Тогда его можно использовать внутри оператора `in`.

```sql
where name_of_attribute in (subquery)
```

Например:

```sql
select title, author, amount, price
from book
where author in (
        select author 
        from book 
        group by author 
        having sum(amount) >= 12
      );
```

Этот запрос выводит информацию о книгах тех авторов, общее количество экземпляров книг которых не менее 12.

### Вложенный запрос, операторы ANY и ALL

Вложенный запрос, возвращающий несколько значений одного столбца можно использовать для отбора записей с помощью операторов `ANY` и `ALL` совместно с операциями сравнения.

Операторы `ANY` и `ALL` используются для сравнения некоторого значения с результирующим набором вложенного запроса, состоящим из одного столбца.

При использовании `ANY` в результирующую таблицу будут включены все записи, для которых выражение со знаком сравнения верно хотя бы для одного элемента результирующего запроса.

Работа `ANY`:

- `amount > ANY(10,12)` эквивалентно `amount > 10`

- `amount < ANY(10,12)` эквивалентно `amount < 12`

- `amount = ANY(10,12)` эквивалентно `amount IN (10,12)` или `(amount = 10) or (amount = 12)`

- `amount <> ANY(10,12)` вернет все записи с любым значением, включая 10 и 12.

При использовании оператора `ALL` в результирующую таблицу будут включены все записи, для которых выражение со знаком сравнения верно для всех элементов результирующего запроса.

Работа `ALL`:

- `amount > ALL(10,12)` эквивалентно `amount > 12`

- `amount < ALL(10,12)` эквивалентно `amount < 10`

- `amount = ALL(10,12)` эквивалентно `(amount = 10) and (amount = 12)` такая запись ничего не вернет

- `amount <> ALL(10,12)` вернет все записи кроме тех, где amount равно 10 или 12

Операторы `ALL` и `ANY` можно использовать **только с вложенными запросами**.

Например:

```sql
select title, author, amount, price
from book
where amount < all(
        select avg(amount) 
        from book 
        group by author 
      );
```

Этот запрос выведет информацию о тех книгах, количество которых меньше самого маленького среднего количества книг каждого автора.

## Вложенный запрос после SELECT

В этом случае результат выполнения запроса выводится в отдельном столбце результирующей таблицы. При этом результатом запроса может быть только одно значение, тогда оно будет повторяться во всех строках. Также вложенный запрос может использоваться в выражениях.

Например:

```sql
select title, author, amount, 
    (
     select avg(amount) 
     from book
    ) as Среднее_количество 
from book
where abs(amount - (select avg(amount) from book)) >3;
```

Данный запрос выводит информацию о книгах, количество экземпляров которых отличается от среднего количества экземпляров книга на складе более чем на 3.

---

## Запросы корректировки данных

### Создание пустой таблицы

Создание таблицы осуществляется с помощью запроса `create`.

### Добавлений записей в таблицу

Добавление одной записи в таблицу осуществляется с помощью запроса `insert`.

Допускается вставка нескольких записей одновременно, для этого используется запрос такого вида:

```sql
insert into table_name(attribute1, attribute2, ..., attributeN)
values
    (value1_1, value1_2, ..., value1_N),
    (value2_1, value2_2, ..., value2_N),
    ...
    (valueM_1, valueM_2, ..., valueM_N);
```

Пример:

```sql
insert into book (title, author, price, amount) 
values 
    ('Война и мир','Толстой Л.Н.', 1070.20, 2),
    ('Анна Каренина', 'Толстой Л.Н.', 599.90, 3);
```

### Добавление записей из другой таблицы

Вместо раздела `values` записывается запрос на выборку, начинающийся с `select`. В нем можно использовать `where, group by, order by`.

Правила соответствия между полями таблицы и вставляемыми значениями из запроса:

1. Количество полей в таблице и количество полей в запросе должны совпадать

2. Должно существовать прямое соответствие между позицией одного и того же элемента в обоих списках, поэтому первый столбец запроса должен относиться к первому столбцу в списке столбцов таблицы, второй - ко второму и т.д.

3. Типы столбцов запроса должны быть совместимы с типами данных соответствующих столбцов таблицы.

Например:

```sql
insert into book (title, author, price, amount) 
select title, author, price, amount 
from supply;
```

Этот запрос вносит все книги из таблицы `supply` в таблицу `book`.

### Добавление записей, вложенные запросы

В запросах на добавление можно использовать вложенные запросы.

Например:

```sql
insert into book (title, author, price, amount) 
select title, author, price, amount 
from supply
where title not in(
        select title 
        from book
      );

select * from book;
```

Этот запрос вносит в таблицу book записи из таблицы supply, которые отсутствуют в book.

### Запросы на обновление

Обновление данных - изменение существующих записей в таблице. Изменение записей доступно с помощью запроса `update`.

Пример:

```sql
update table_name set field = expression;
```

С помощью запросов на обновление можно изменять не все записи в таблице, а только часть из них. Для этого в запрос добавляют `where`, после которого указывается условие отбора строк для изменения.

Пример:

```sql
update book
set price = 0.7 * price
where amount < 5;
```

### Запросы на обновление нескольких столбцов

Пример:

```sql
update table_name set field1 = expression1, field2 = expression2
```

Пример:

```sql
update 
    book 
set 
    buy = if (buy > amount, amount, buy), 
    price = if (buy = 0, price * 0.9, price);
```

### Запросы на обновление нескольких таблиц

В запросах на обновление можно использовать несколько таблиц, но тогда:

- Для столбцов, имеющих одинаковые имена, необходимо указывать имя таблицы, к которой они относятся (например `book.price` или `supply.price`)

- Все таблицы, используемые в запросе, нужно перечислить после ключевого слова `update`

- В запросе обязательно условие `where`, в котором указывается условие при котором обновляются данные

Пример:

```sql
update book, supply 
SET book.amount = book.amount + supply.amount
WHERE book.title = supply.title AND book.author = supply.author;
```

### Запросы на удаление

Запросы корректировки данных позволяют удалить одну или несколько записей из таблицы. 

Пример:

```sql
delete from table_name
```

Этот запрос удаляет все записи из указанной таблицы.

Удалять можно по условию.

Пример:

```sql
delete from table_name
where condition;
```

### Запросы на создание таблицы

Новая таблица может быть создана на основе данных из другой таблицы. Для этого используется запрос `select`, результирующая таблица которого и будет новой таблицей базы данных.

Пример:

```sql
create table table_name as
select ...
```

Пример:

```sql
create table ordering as
select author, title, 5 as amount
from book
where amount < 4;
```

Этот запрос создает таблицу заказ, куда включает авторов и название тех книг, количество экземпляров которых в таблице book меньше 4 и устанавливает количество экземпляров равным 5.

При создании таблицы можно использовать вложенные запросы после `select` и `where`.

Пример:

```sql
create table ordering as
select author,
       title,
       (select round(avg(amount))
       from book) as amount
from book
where amount < 4;
```

## Запросы на выборку

### Оператор LIMIT

Используется для ограничения вывода записей. Результирующая таблица будет иметь количество строк не более указанного после `limit`. `limit` размещается после раздела `order by`.

Пример:

```sql
select *
from trip
order by date_first
limit 1;
```

### Работа с датами

Для вычитания двух дат используется функция `datediff(date1, date2)`. Результатом является количество дней между date1 и date2.

Пример:

```sql
DATEDIFF('2020-04-01', '2020-03-28')=4
DATEDIFF('2020-05-09','2020-05-01')=8
```

Для того, чтобы выделить номер месяца из даты используется функция `month(date)`.

Пример:

```sql
month('2020-04-12')=4
```

Для выделения названия месяца из даты используется функция `monthname(date)`, которая возвращает название месяца на английском языке для указанной даты.

Пример:

```sql
monthname('2020-04-12')='April'
```

### Использование временного имени (алиаса)

Алиас - псевдоним, который присваивается столбцам или таблицам. Есть 2 варианта присваивания:

1. С использованием ключевого слова `as`
   
   ```sql
   from table_name as t
   ```

2. Без ключевого слова `as`
   
   ```sql
   from table_name t
   ```

После присвоения таблице алиаса его можно использовать во всех разделах запроса.

Пример:

```sql
select  f.name, f.number_plate, f.violation, 
   if(
    f.sum_fine = tv.sum_fine, "Стандартная сумма штрафа", 
    if(
      f.sum_fine < tv.sum_fine, "Уменьшенная сумма штрафа", "Увеличенная сумма штрафа"
    )
  ) as description               
from  fine f, traffic_violation tv
where tv.violation = f.violation and f.sum_fine is not NULL;
```

---

# Запросы SQL к связанным таблицам

## Связи между таблицами

Средствами SQL запросов можно выбирать и обрабатывать данные не только из одной таблицы, но из нескольких связанных таблиц.
