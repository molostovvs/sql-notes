# Основы реляционной модели

## Отношение (таблица)

 Реляционная модель определяет способ представления данных (структуру данных), методы защиты данных (целостность данных), и операции, которые можно выполнять с данными (манипулирование данными).

<img title="" src="file:///C:/Users/molos/AppData/Roaming/marktext/images/2023-03-30-13-07-17-image.png" alt="" width="570" data-align="center">

*Отношение* - структура данных целиком, набор записей (иногда называют таблица)

*Кортеж* - каждая строка, содержащая данные (иногда называют запись)

*Мощность* - число кортежей в таблице

*Атрибут* - столбец в таблице (иногда называют поле)

*Размерность* - число атрибутов в таблице

*Домен атрибута* - допустимые значения, которые можно занести в поле

### Отношение, реляционная модель

Обязательным этапом перед созданием БД является ее проектирование.

Имя таблицы (отношения) должно быть уникальным в пределах БД. Рекомендуется существительное в единственном числе, понятное имя, описывающее моделируемый объект, имя должно быть короткое (до 10 символов).

Имя поля должно быть уникальным в пределах таблицы. Рекомендуется разделять составные имена подчеркиванием.

Ключевые поля должны состоять из двух частей: названия таблицы и `id`, например `book_id`.

### Типы данных полей

`int, integer` - целые числа (32 bit)

`decimal, numeric` - вещественное число, в скобках указывается максимальная длина числа. Например `decimal(6,3)` означает вещественное число с 6 цифрами в числе и 3 цифры после запятой, например для `decimal(6,3)` это `123,456`. 

`date` - дата в формате ГГГГ-ММ-ДД

`varchar` - строка длиной не более 255 символов в однобайтовой кодировке.

Для описания ключевого поля можно использовать `int primary key auto_increment`

### Создание таблицы

Для создания таблицы используется SQL-запрос. Ключевое слово `create table`. Пример запроса:

```sql
create table genre(
    genre_id int primary key auto_increment,
    name_genre varchar(30)
);
```

В конце sql-запроса ставится точка с запятой. Но для одного запроса это не обязательно.

### Вставка записи в таблицу

Для занесения новой записи в таблицу используется SQL-запрос, в котором указывается в какую таблицу, в какие поля заносить новые значения.

Пример запроса:

```sql
insert into table(field1, field2)
values (value1, value2);
```

В результате выполнения этого запроса новая запись добавится в конец указанной таблицы.

Рекомендуется заполнять все поля записи, если же поле пропущено, значение этого поля зависит от установленных по умолчанию значений, если значения не установлены, то вставляется `null`.

Значения поля `primary key auto_increment` формируется автоматически, т.е. его не нужно указывать при добавлении значения в таблицу.

---

## Выборка данных

### Выборка всех данных из таблицы

Для выборки данных из таблицы используется ключевое слово `select`. Также для выборки всех данных без указания атрибутов таблицы можно использовать знак `*`. Таким образом для выборки всех записей из таблицы используется запрос:

```sql
select * from table
```

### Выборка отдельных столбцов

Для выборки отдельных столбцов после ключевого слова `select` необходимо написать атрибуты, которые мы хотим видеть в выборке. Например:

```sql
select attribute1,
       attrubite2
from table;
```

### Выборка новых столбцов и присвоение им новых имен

Для того чтобы присвоить атрибуту новое имя используется ключевое слово `as`. Например:

```sql
select attribute1 as new_name_attribute1,
       attribute2
from table;
```

### Выборка данных с созданием вычисляемого столбца

Результатом выборки является таблица, в которую включены все данные из указанных после `select` столбцов, а также новый столбец, в каждой строке которого вычисляется заданное выражение.

Например:

```sql
select attribute1,
       attribute2,
       attribute3 * constant as new_attribute3
from table;
```

### Выборка данных, вычисляемые столбцы, математические функции

Некоторые из функций, реализованных в SQL:

1. `ceiling(x)` - округление до целого в большую сторону

2. `round(x,k)` - округление **x** до **k** знаков после запятой, если не указано **k**, то округлят до целого

3. `floor(x)` - округляет до целого числа в меньшую сторону

4. `power(x,y)` - возведение **x** в степень **y**

5. `sqrt(x)` - квадратный корень из **x**

6. `degrees(x)` - конвертирует значение **x** из радиан в градусы

7. `radians(x)` - конвертирует значение **и** из градусов в радианы

8. `abs(x)` - модуль числа **x**

9. `PI()` - число $\pi$

### Выборка данных, вычисляемые столбцы, логические функции

В SQL можно заносить в поле значение на основании условия. Для это применяют функцию `if()`:

```sql
if(expression, result_if_true, result_if_false)
```

### Выборка данных по условию

С помощью запросов можно включать в итоговую выборку не все строки исходной таблицы, а только те, которые соответствуют условию. Для этого после указания таблицы задается ключевое слово `where` и логическое выражение.

Операторы сравнения могут быть:

| Оператор | Значение         |
|:--------:|:----------------:|
| =        | равно            |
| <>       | не равно         |
| >        | больше           |
| <        | меньше           |
| >=       | больше или равно |
| <=       | меньше или равно |

Например:

```sql
select attribute1,
       attribute2,
from table
where attribute1 * constant1 >= contstant2;
```

### Выборка данных, логические операции

Логическое выражение может включать логические операции `and` ,`or` ,`not` и круглые скобки.

Приоритет операций:

1. Скобки

2. Умножение, деление

3. Сложение, вычитание

4. Операторы сравнения

5. `not`

6. `and`

7. `or`

Например:

```sql
select attribute1,
       attribute2,
from table
where attribute1 > constant1 and attribute2 = contstant2;
```

### Выборка данных, операторы between, in

Логические выражения могут включать операторы `between` и `in`. Приоритет этих операторов как у оператора `if`.

Оператор `between` отбирает данные, относящиеся к некоторому интервалу, включая границы.

Оператор `in` выбирает данные, соответствующие значениям из списка.

### Выборка данных с сортировкой

Для сортировки используется ключевое слово `order by`, после которого указываются имена столбцов. Строки сортируются по первому столбцу, а если указан второй, то сортировка происходит только для тех строк, у которых значение первого столбца одинаковы. По умолчанию сортировка при помощи `order by` происходит по возрастанию, чтобы указать порядок сортировки после имени столбца можно указать ключевое слово `asc` (по возрастанию) или `desc` (по убыванию).

Столбцы для `order by`  можно указывать названием столбца, номером столбца или псевдонимом (указанным после `as`).

### Выборка данных, оператор like

Оператор `like` используется для сравнения строк. Этот оператор позволяет сравнивать строки на неполное совпадение, а по шаблону. Шаблон может включать любой символ и *символ-шаблон* (`%` и `_`). Где `%` - строка любой длины, а `_` - любой одиночный символ.

Например `like '%M.%'` выберет все строки, содержащие `M.`, а `like 'Поэм_'` выберет все строки, начинающиеся с `Поэм` и заканчивающиеся любым символом.

---

## Запросы, групповые операции

### Выбор уникальных элементов столбца

Чтобы отобрать уникальные элементы используют ключевое слово `distinct` после `select`.

Например:

```sql
select distinct attribute1
from table;
```

Для этого также можно использовать оператор `group by`, который группирует данные при выборке с одинаковыми значениями.

Тот же пример, что и выше, но с использованием `group by`

```sql
select attribute1
from table
group by author;
```

### Выборка данных, групповые функции SUM и COUNT

При группировке можно выполнить действие с элементами, входящими в группу, например просуммировать все сгруппированные значения.

Пример группировки:

```sql
select attribute1, 
       sum(attribute2), 
       sum(attribute3)
from table
group by attribute1;
```

`sum` позволяет сложить элементы каждой группы, а `count` позволяет посчитать количество элементов в каждой группе.

`count(*)` - подсчитывает все записи в группе, в том числе со значением `null`.

`count(attribute)` - подсчитывает все записи в группе с условием `not null`.

В агрегатных функциях (таких как `sum` и `count`) можно использовать ключевое слово `distinct` для подсчета уникальных значений.

### Выборка данных, групповые функции MIN, MAX, AVG

К групповым функциям относят: `min()`, `max()`, `avg()`.

### Выборка данных с вычислением, групповые функции

В качестве аргумента групповой функции может использоваться любое допустимое в SQL арифметическое выражение.

Например:

```sql
select attribute1,
       sum(attribute2 * attribute3) as name
from table
group by attribute1;
```

Групповые функции могут быть элементами выражений. Т.е. можно написать 

```sql
round(sum(attribute2 * attribute3), 2)
```

### Вычисления по таблице целиком

Групповые функции можно применять к целому столбцу без группировки.

Например:

```sql
select sum(attribute)
from table;
```

Результатом таких запросов является единственная строка с вычисленными по таблице значениями.

### Выборка данных по условию, групповые функции

В запросы с групповыми функциями можно включать условие отбора строк. В таких запросах вместо `where` используется ключевое слово `having`, которое размещается после `group by`.

Например:

```sql
select attribute1,
       min(attribute2),
       max(attribute2)
from table
group by attribute1
having sum(attribute2 * attribute3) > constant1
```

Оптимизация от ChatGPT:

```sql
WITH temp AS (
  SELECT attribute1, attribute2, attribute3
  FROM table
  WHERE (attribute2 IS NOT NULL) AND (attribute3 IS NOT NULL)
)
SELECT attribute1, MIN(attribute2), MAX(attribute2)
FROM temp
GROUP BY attribute1
HAVING SUM(attribute2 * attribute3) > constant1;
```

### Выборка данных по условию, групповые функции, WHERE и HAVING

`where` и `having` могут использоваться в одном запросе. При этом необходимо учитывать порядок выполнения SQL-запроса:

1. FROM

2. WHERE

3. GROUP BY

4. HAVING

5. SELECT

6. ORDER BY

## Вложенные запросы

Вложенный запрос - запрос внутри другого запроса SQL.

Вложенный запрос используется для выборки данных, которые будут использоваться в условии отбора записей основного запроса. Его применяют для:

- сравнения выражения с результатом вложенного запроса

- определения того, включено ли выражение в результаты вложенного запроса

- проверки того, выбирает ли запрос определенные строки

Составляющие вложенного запроса:

- Ключевое слово `select` после которого указываются имена столбцов или выражения
- Ключевое слово `from` и имя таблицы
- Необязательное предложение `where`
- Необязательное предложение `group by` и `having`

Вложенные запросы могут включаться в `where` и `having` так:

- `where | having` expression *оператор сравнения* (вложенный запрос)
- `where | having` expression, включающее вложенный запрос
- `where | having` expression `[NOT] IN` (вложенный запрос)
- `where | having` expression *оператор сравнения* `ANY | ALL` (вложенный запрос)

Также вложенные запросы могут вставляться в основной запрос после ключевого слова `select`.

### Вложенный запрос, возвращающий одно значение

Такой запрос может использоваться в условии отбора записей `where` как обычное значение вместе с операторами сравнения.
